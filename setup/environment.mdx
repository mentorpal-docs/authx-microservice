# Environment Configuration

Configure AuthX for different environments.

## Environment Files

AuthX uses environment-specific `.env` files:

```
.env.development    # Development (local)
.env.uat            # UAT (staging)
.env.production     # Production (live)
```

Copy the appropriate file:

```bash
cp .env.development .env      # For development
cp .env.uat .env              # For UAT
cp .env.production .env       # For production
```

## Configuration Variables

### Server Configuration

```env
# Application environment
NODE_ENV=development          # development | uat | production

# Server port
PORT=3000                     # HTTP listening port

# API Base URL (for email links, etc.)
API_URL=http://localhost:3000
```

### Database Configuration

```env
# MongoDB connection
MONGODB_URI=mongodb://localhost:27017/authx

# Connection pool
MONGODB_POOL_SIZE=10
MONGODB_TIMEOUT=5000
MONGODB_RETRY_WRITES=true

# Database name
DB_NAME=authx
```

### Cache Configuration

```env
# Redis connection
REDIS_URL=redis://localhost:6379

# Redis options
REDIS_DB=0
REDIS_PASSWORD=         # Optional
REDIS_PORT=6379
REDIS_HOST=localhost
```

### Security Configuration

```env
# JWT Configuration
JWT_SECRET=your-super-secret-key-change-this
JWT_ALGORITHM=HS256
JWT_EXPIRY=1h
JWT_ISSUER=authx

# Refresh Token
REFRESH_TOKEN_EXPIRY=1y
REFRESH_TOKEN_LENGTH=32

# Password Hashing
BCRYPT_ROUNDS=10        # 10 in dev, 12 in prod

# Account Security
FAILED_LOGIN_ATTEMPTS=5
ACCOUNT_LOCKOUT_TIME=30 # minutes

# OTP Configuration
OTP_LENGTH=6
OTP_EXPIRY=600          # 10 minutes in seconds
```

### Email Configuration

```env
# SMTP Server
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password
EMAIL_FROM=noreply@example.com

# Email Service (optional)
SENDGRID_API_KEY=your-sendgrid-key

# Email verification
EMAIL_VERIFICATION_ENABLED=false
EMAIL_VERIFICATION_EXPIRY=86400  # 24 hours
```

### CORS Configuration

```env
# Allowed origins (comma-separated)
CORS_ORIGIN=http://localhost:3000,http://localhost:3001

# CORS options
CORS_CREDENTIALS=true
CORS_METHODS=GET,POST,PUT,DELETE,PATCH
CORS_HEADERS=Content-Type,Authorization
```

### Rate Limiting

```env
# Rate limiting window (minutes)
RATE_LIMIT_WINDOW=15

# Rate limit thresholds
SIGNUP_LIMIT=3          # per hour
LOGIN_LIMIT=5           # per 15 minutes
PASSWORD_RESET_LIMIT=3  # per hour
OTP_LIMIT=5             # per hour
GENERAL_API_LIMIT=100   # per minute

# Disable for development
RATE_LIMIT_ENABLED=true
```

### Logging Configuration

```env
# Log level: error | warn | info | debug
LOG_LEVEL=info

# Log file paths
LOG_FILE=logs/combined.log
ERROR_LOG_FILE=logs/error.log

# Log format
LOG_FORMAT=json          # json | simple | combined

# Log retention (days)
LOG_RETENTION=30
```

### Application Features

```env
# Feature flags
FEATURE_EMAIL_VERIFICATION=false
FEATURE_TWO_FACTOR_AUTH=false
FEATURE_OAUTH_LOGIN=false
FEATURE_SOCIAL_LOGIN=false

# Maintenance mode
MAINTENANCE_MODE=false
MAINTENANCE_MESSAGE=Server is under maintenance
```

## Environment-Specific Examples

### Development

```env
NODE_ENV=development
PORT=3000

MONGODB_URI=mongodb://localhost:27017/authx-dev
REDIS_URL=redis://localhost:6379

JWT_SECRET=dev-secret-key-for-development-only
BCRYPT_ROUNDS=10

EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=dev@example.com
EMAIL_PASSWORD=dev-password

CORS_ORIGIN=http://localhost:3000,http://localhost:3001

LOG_LEVEL=debug
RATE_LIMIT_ENABLED=false

FEATURE_EMAIL_VERIFICATION=false
```

### UAT (Staging)

```env
NODE_ENV=uat
PORT=3000

MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/authx-uat
REDIS_URL=redis://uat-redis-cluster:6379

JWT_SECRET=uat-secret-key-min-32-characters-long
BCRYPT_ROUNDS=10

EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_USER=apikey
EMAIL_PASSWORD=sendgrid-api-key

CORS_ORIGIN=https://uat.example.com

LOG_LEVEL=info
RATE_LIMIT_ENABLED=true

FEATURE_EMAIL_VERIFICATION=true
```

### Production

```env
NODE_ENV=production
PORT=3000

MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/authx-prod
REDIS_URL=redis://prod-redis-cluster:6379

JWT_SECRET=prod-secret-key-min-32-characters-long-change-monthly
BCRYPT_ROUNDS=12

EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_USER=apikey
EMAIL_PASSWORD=sendgrid-api-key

CORS_ORIGIN=https://app.example.com,https://www.example.com

LOG_LEVEL=warn
RATE_LIMIT_ENABLED=true

FEATURE_EMAIL_VERIFICATION=true
FEATURE_TWO_FACTOR_AUTH=true
```

## Securing Sensitive Values

### Best Practices

1. **Never commit `.env` to Git**
   ```bash
   # .gitignore
   .env
   .env.local
   .env.*.local
   ```

2. **Use environment-specific secrets**
   ```bash
   # .env.production
   JWT_SECRET=<secret-from-vault>
   
   # Or via CI/CD pipeline
   export JWT_SECRET=${{ secrets.JWT_SECRET }}
   ```

3. **Rotate secrets regularly**
   ```bash
   # Change JWT_SECRET monthly
   # Update database passwords quarterly
   # Rotate API keys every 6 months
   ```

4. **Use secure vault**
   ```bash
   # AWS Secrets Manager
   # HashiCorp Vault
   # Azure Key Vault
   # 1Password / LastPass
   ```

## Validating Configuration

```bash
# Check if .env is properly loaded
npm run config:validate

# Expected output:
# ✓ NODE_ENV set to development
# ✓ MongoDB URI valid format
# ✓ Redis URL valid format
# ✓ JWT_SECRET length sufficient
# ✓ All required variables present
```

## Configuration in Production

### Docker Secrets

```bash
# Store secrets in Docker
echo "your-jwt-secret" | docker secret create jwt_secret -

# Reference in service
environment:
  JWT_SECRET: /run/secrets/jwt_secret
```

### Kubernetes Secrets

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: authx-secrets
type: Opaque
data:
  JWT_SECRET: <base64-encoded-secret>
  MONGODB_URI: <base64-encoded-uri>
```

### Environment Validation Checklist

- [ ] All required variables present
- [ ] SECRET_KEY length sufficient (32+ chars)
- [ ] Database URI correct format
- [ ] Redis URL accessible
- [ ] Email credentials valid
- [ ] CORS origins whitelisted
- [ ] LOG_LEVEL appropriate
- [ ] Rate limiting thresholds set
- [ ] Feature flags configured
- [ ] API URL matches client configuration

## Dynamic Configuration

Load configuration at runtime:

```javascript
// config/index.js
module.exports = {
  nodeEnv: process.env.NODE_ENV,
  port: parseInt(process.env.PORT || '3000'),
  database: {
    uri: process.env.MONGODB_URI,
    poolSize: parseInt(process.env.MONGODB_POOL_SIZE || '10')
  },
  jwt: {
    secret: process.env.JWT_SECRET,
    expiry: process.env.JWT_EXPIRY || '1h'
  }
};
```

## Troubleshooting Configuration

### Variable Not Loading

```bash
# Verify .env file exists
ls -la .env

# Check file permissions
chmod 600 .env

# Verify variable is set
echo $NODE_ENV

# Manually export if needed
export NODE_ENV=development
```

### Invalid Configuration

```bash
# Validate configuration
npm run config:check

# Check environment
env | grep -i mongo
env | grep -i redis
env | grep -i jwt
```

---

**Next:**
- [Installation](./installation) - Install dependencies
- [Database Setup](./database) - Initialize databases
- [Running Server](../development/running-server) - Start developing
